<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sky Enterprises - Billing Pro</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
	<style>
		.login-card {
			max-width: 400px;
			margin: 80px auto;
			border-radius: 15px;
		}

		.dashboard-container {
			display: none;
			padding: 20px;
		}

		.live-total-box {
			background: #e9f7ef;
			padding: 15px;
			border-radius: 10px;
			border: 1px solid #28a745;
		}
	</style>
</head>
<body class="bg-light">

	<div id="loginPage" class="container">
		<div class="card login-card shadow-lg p-4 text-center">
			<h2 class="text-primary">SKY ENTERPRISES</h2>
			<p class="text-muted">Smart Billing System</p>
			<input type="password" id="adminPass" class="form-control mb-3" placeholder="Enter Password">
			<button onclick="checkLogin()" class="btn btn-primary w-100">Login</button>
		</div>
	</div>

	<div id="dashboard" class="container dashboard-container">
		<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
			<div>
				<h2 class="m-0 text-primary">Billing Dashboard</h2>
				<small class="text-muted">GSTIN: 33DBYPM6097M1ZJ</small>
			</div>
			<button onclick="location.reload()" class="btn btn-outline-danger btn-sm">Logout</button>
		</div>

		<div class="card p-4 shadow-sm mb-4 border-0">
			<h5 class="mb-3">Create New Invoice</h5>
			<div class="row g-3">
				<div class="col-md-3">
					<label class="form-label">Customer Name</label>
					<input type="text" id="cName" class="form-control" placeholder="Name">
				</div>
				<div class="col-md-2">
					<label class="form-label">Phone</label>
					<input type="text" id="cPhone" class="form-control" placeholder="WhatsApp Number">
				</div>
				<div class="col-md-3">
					<label class="form-label">Select Product</label>
					<select id="mat" class="form-select" onchange="updatePrice()">
						<option value="">-- Select --</option>
						<option value="Jalli (Blue Metal)">Jalli (Blue Metal)</option>
						<option value="M-Sand">M-Sand</option>
						<option value="P-Sand">P-Sand</option>
						<option value="Bricks">Bricks</option>
					</select>
				</div>
				<div class="col-md-1">
					<label class="form-label">Qty</label>
					<input type="number" id="qty" class="form-control" value="1" oninput="calculateLive()">
				</div>
				<div class="col-md-1">
					<label class="form-label">Rate</label>
					<input type="number" id="price" class="form-control" oninput="calculateLive()">
				</div>
				<div class="col-md-2 d-flex align-items-end pb-2">
					<div class="form-check form-switch">
						<input class="form-check-input" type="checkbox" id="gstToggle" onchange="calculateLive()">
						<label class="form-check-label">Add 18% GST</label>
					</div>
				</div>

				<div class="col-12 d-flex justify-content-between align-items-center mt-4 live-total-box">
					<div>
						<h4 id="liveTotal" class="text-success m-0">Grand Total: ₹0.00</h4>
						<small id="liveGst" class="text-muted">GST Included: ₹0.00</small>
					</div>
					<button onclick="saveBill()" id="saveBtn" class="btn btn-success px-5 py-2 fw-bold">SAVE & DOWNLOAD PDF</button>
				</div>
			</div>
		</div>

		<div class="card p-0 shadow-sm border-0">
			<div class="p-3 bg-dark text-white d-flex justify-content-between align-items-center rounded-top">
				<h5 class="m-0">Recent Transactions</h5>
				<button onclick="fetchData()" class="btn btn-sm btn-light">Refresh List</button>
			</div>
			<div class="table-responsive">
				<table class="table table-hover align-middle m-0 text-center">
					<thead class="table-light">
						<tr>
							<th>Date</th>
							<th>Customer</th>
							<th>Product</th>
							<th>Qty</th>
							<th>Total</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="billTableBody"></tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
		const API_URL = "YOUR_APPS_SCRIPT_URL_HERE"; // PASTE YOUR DEPLOYED URL HERE
		const productPrices = {
			"Jalli (Blue Metal)": 3500,
			"M-Sand": 2800,
			"P-Sand": 4200,
			"Bricks": 15
		};

		function checkLogin() {
			if (document.getElementById('adminPass').value === "12345") {
				document.getElementById('loginPage').style.display = 'none';
				document.getElementById('dashboard').style.display = 'block';
				fetchData();
			} else { alert("Wrong Password Machi!"); }
		}

		function updatePrice() {
			const mat = document.getElementById('mat').value;
			if (productPrices[mat]) {
				document.getElementById('price').value = productPrices[mat];
			}
			calculateLive();
		}

		function calculateLive() {
			const qty = parseFloat(document.getElementById('qty').value) || 0;
			const price = parseFloat(document.getElementById('price').value) || 0;
			const isGST = document.getElementById('gstToggle').checked;

			const sub = qty * price;
			const gst = isGST ? (sub * 0.18) : 0;
			const total = sub + gst;

			document.getElementById('liveTotal').innerText = `Grand Total: ₹${total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
			document.getElementById('liveGst').innerText = `GST Included: ₹${gst.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
		}

		async function saveBill() {
			const btn = document.getElementById('saveBtn');
			btn.disabled = true; btn.innerText = "Saving...";

			const qty = document.getElementById('qty').value;
			const price = document.getElementById('price').value;
			const isGST = document.getElementById('gstToggle').checked;
			const sub = qty * price;
			const gst = isGST ? (sub * 0.18) : 0;

			const payload = {
				action: "insert",
				name: document.getElementById('cName').value,
				phone: document.getElementById('cPhone').value,
				material: document.getElementById('mat').value,
				qty: qty, price: price,
				isGST: isGST ? "Yes" : "No",
				gstAmt: gst.toFixed(2),
				total: (sub + gst).toFixed(2)
			};

			await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
			alert("Success! PDF will download now.");
			downloadPDF(payload);
			location.reload();
		}

		async function fetchData() {
			const res = await fetch(API_URL);
			const allBills = await res.json();
			const tbody = document.getElementById('billTableBody');
			tbody.innerHTML = allBills.map(b => `
					<tr>
						<td>${new Date(b.Date).toLocaleDateString()}</td>
						<td class="fw-bold">${b.CustomerName}</td>
						<td>${b.Material}</td>
						<td>${b.qty}</td>
						<td class="text-success">₹${b.total}</td>
						<td>
							<button onclick='downloadPDF(${JSON.stringify(b)})' class="btn btn-sm btn-outline-info">PDF</button>
							<a href="https://wa.me/91${b.Phone}?text=Hi ${b.CustomerName}, Invoice for ${b.Material}: Total ₹${b.total}" target="_blank" class="btn btn-sm btn-outline-success">WA</a>
						</td>
					</tr>
				`).join('');
		}

		function downloadPDF(b) {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();

			// Layout
			doc.setFontSize(22); doc.setTextColor(40);
			doc.text("SKY ENTERPRISES", 105, 20, { align: "center" });
			doc.setFontSize(10); doc.text("GSTIN: 33DBYPM6097M1ZJ | Jalli & M-Sand Supply", 105, 28, { align: "center" });
			doc.line(10, 32, 200, 32);

			doc.setFontSize(11);
			doc.text(`Customer: ${b.name || b.CustomerName}`, 15, 45);
			doc.text(`Phone: ${b.phone || b.Phone}`, 15, 52);
			doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 45);

			doc.autoTable({
				startY: 60,
				head: [['Description', 'Quantity', 'Rate', 'Amount']],
				body: [[b.material || b.Material, b.qty, b.price, (b.qty * b.price).toFixed(2)]],
				theme: 'grid',
				headStyles: { fillColor: [40, 40, 40] }
			});

			let finalY = doc.lastAutoTable.finalY + 10;
			doc.text(`Sub-Total: Rs.${(b.qty * b.price).toFixed(2)}`, 140, finalY);
			if (b.isGST === "Yes") {
				doc.text(`GST (18%): Rs.${b.gstAmt}`, 140, finalY + 7);
				finalY += 7;
			}
			doc.setFont(undefined, 'bold');
			doc.text(`Grand Total: Rs.${b.total}`, 140, finalY + 10);

			doc.save(`Invoice_${b.name || b.CustomerName}.pdf`);
		}
	</script>
</body>
</html>